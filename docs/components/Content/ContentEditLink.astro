---
import ContentFooterLink from './ContentFooterLink.astro'
import PencilIcon from '../../icons/pencil.svg'

interface Props {
  url: undefined | string
}

let { url } = Astro.props
---

{
  url && (
    <ContentFooterLink
      id="edit-page-link"
      url={url}
    >
      <PencilIcon
        class="icon"
        slot="icon"
      />
      Edit this page
    </ContentFooterLink>
  )
}

<script>
  {
    let controller: AbortController | undefined

    let cleanup = () => {
      controller?.abort()
      controller = undefined
    }

    let scheduleNext = () => {
      document.addEventListener(
        'astro:before-swap',
        () => {
          cleanup()
        },
        { once: true },
      )
      document.addEventListener(
        'astro:after-swap',
        () => {
          setup()
        },
        { once: true },
      )
    }

    let setup = () => {
      cleanup()

      controller = new AbortController()

      let editLink = document.getElementById('edit-page-link')
      if (editLink) {
        editLink.addEventListener(
          'click',
          () => {
            if (globalThis.fathom) {
              globalThis.fathom.trackEvent('click: edit this page')
            }
          },
          { signal: controller.signal },
        )
      }

      scheduleNext()
    }

    setup()
  }
</script>

<style>
  .icon {
    inline-size: var(--size-icon-s);
    block-size: var(--size-icon-s);
  }
</style>
